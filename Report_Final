---
title: "Serbian Spa Waters Report"
author: "Leah Ye (300651931), Harry Philpott (300667756),


Claude Butler (300651409), Elizabeth Myers (300641471)"
output: bookdown::pdf_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE
)
library(dplyr)
library(knitr)
library(GGally)
library(ggplot2)
library(tidyr)
library(corrplot)
library(kableExtra)
library(plotly)
library(MASS)
```

# **Introduction**

This study analyzed hydrochemical data for mineral and thermal waters in 
Serbian territory. The diversity of the composition of these waters reflects on 
the geological and geographical diversity of the Serbian territory on which they
are located. The authors used principal component analysis (PCA) and 
hierarchical cluster analysis (HCA) to characterize the chemical composition 
and natural radioactivity of these water samples, understand the relationships 
between the variables measured, and classify the waters with respect to their 
geotectonic units. PCA revealed four latent factors that accounted for 74.2% of 
the variability among the observations. Two of these four PCs are based on 
measures of mineralisation of the components of the host rock, and the other 
two are based on variables that are indicative of natural radioactivity. The 
results of PCA achieved a total correct classification of 83.3% for predefined 
geotectonic units, and the dendrogram of HCA classified the samples into four 
major groups and eleven subgroups.

# **Methodology**

The Serbian Spa Waters Dataset contains 30 observations(sites), with 15 columns:

-   idNum: Integer - Index of each observation;\
-   waterSource: Character - Spa/Spring the observation belongs to;\
-   tempCels: Numerical - Outflowing temperature (°C);\
-   pH: Numerical - pH level(Acidity/Alkalinity);\
-   elecCond: Integer - Electrical Conductivity of water measured immediately 
    after collection on the spot, total ion concentration ($\mu$S/cm);\
-   totSolid: Numerical - Total dissolved solids (g/L)\
-   Ca2: Numerical - Calcium (mg/L);\
-   Mg2: Numerical - Magnesium (mg/L);\
-   Na: Numerical - Sodium (mg/L);\
-   K: Numerical - Potassium (mg/L);\
-   Cl: Numerical - Chlorine (mg/L);\
-   S02: Numerical - Sulfate (mg/L);\
-   HCO: Numerical - Bicarbonate (mg/L);\
-   Si0: Numerical - Silica, dissolved silicon dioxide (mg/L);\
-   geoStruct: Integer - The geological structure the water was collected from 
    (1 = Hydrological Basin, 2 = Karstic terrains, 3 = Volcanogen Massifs, 
     4 = Metamorphic Regions).

Ions $\mathrm{(HCO_3^-, Ca^{2+}, Mg^{2+}, Na^+, K^+, Cl^-, SO_4^{2-}, SiO_2)}$ 
were analysed in the laboratories of the Institute of Public Health of Serbia. 
Titration methods were applied to measure alkalinity of $Ca^{2+}$ and $Mg^{2+}$. 
Concentrations of $Na^+$ and $K^+$ were determined by atomic absorption 
spectrophotometry.

Where Hyodrological Basins and Karstic terrains have 5 observations each, 
Volcanogen Massifs has 14 observations, and Metamorphic Regions has 6 
observations. This is an unbalanced dataset since there are varying observations 
per group. There are no duplicates, missing data, zeros, negatives, NAs or NULL values in 
the dataset.

Exploratory data analysis will assess basic summary statistics of the data.
We will utilise graphical analysis of box plots and a QQ plot to 
check basic assumptions of  required for further analysis, such as both
univariate and multivariate normality. A correlation plot and Principal 
Component Analysis (PCA) will be performed to further investigate the 
relationships between variables. We will also identify outliers and 
surprising observations within the data, using standard deviation as well as
Mahalanobis distance, and in terms of the principal components.

Our initial exploratory data analysis revealed that the dataset was 
characterised by high variability and right-skewedness, leading us to perform
a log transformation on the data and use these transformed variables for our 
analysis.

We will assess the validity of the paper's geoStruct groups based on the data,
using the methods of MANOVA and Naive Bayes Classifier, as a group covariance check revealed
that the data violates the assumptions for Linear Discriminant Analysis.

We will then use factor analysis to attempt to improve on the paper's model 
parsimony; factor analysis is better for model selection since it doesn't 
include noise like PCA, and maintains parsimony. 

# **Results and Discussion**

## EDA

```{r echo=FALSE}
data <- read.csv("serbianspawater.csv")
```

```{r echo=FALSE}
# Select numeric columns
numeric_cols <- data[sapply(data, is.numeric) & !(names(data) %in% c("idNum", "geoStruct"))]

# Create summary table
summary <- data.frame(
  Variable = names(numeric_cols),
  Mean     = round(sapply(numeric_cols, mean), 2),
  Median   = round(sapply(numeric_cols, median), 2),
  SD       = round(sapply(numeric_cols, sd), 2),
  Min      = round(sapply(numeric_cols, min), 2),
  Max      = round(sapply(numeric_cols, max), 2),
  row.names = NULL
)

# Format summary to show two decimal places
summary_formatted <- summary
summary_formatted[, 2:6] <- lapply(summary[, 2:6], function(x) sprintf("%.2f", x))

# Display table
kable(summary_formatted, caption = "Summary Statistics for Numeric Columns", align = c("l", "r", "r", "r", "r", "r")) %>%
  kable_styling(latex_options = "H", position = "center") %>%
  row_spec(0, extra_css = "font-family: serif;") %>%  
  column_spec(1:ncol(summary), extra_css = "font-family: serif;")  
```

This dataset is characterized by high variability (Table 1). This is likely due to the 
different water sources. pH is more consistent, ranging from neutral (6.5) to 
slightly basic (9.0), which are fairly typical values for water in nature. The 
range of temperatures recorded in this dataset is from 14.40 to 95.00 degrees 
celcius. The large standard deviation confirms that there is a lot of 
variability in temperature. Some of these water sources are near boiling 
temperatures. Electrical conductivity also has a very large range, from 110.00 
to 5100.00 $\mu$S/cm. This indicates that some water samples have a lot of 
dissolved ions, leading to high conductivity. This measure is roughly 
proportional to the total dissolved solids, which also displays a large range, 
from 0.10 to 6.20. The maximum is more than three standard deviations above the 
mean, suggesting right-skew and surprising observations. There are eight major 
ions in this dataset: Calcium ($\mathrm{Ca^{2+}}$), 
Magnesium ($\mathrm{Mg^{2+}}$), Sodium ($\mathrm{Na^+}$), 
Potassium ($\mathrm{K^+}$), Chloride ($\mathrm{Cl^-}$), 
Sulfate ($\mathrm{SO_4^{2-}}$), Bicarbonate ($\mathrm{HCO_3^-}$), and 
Silica ($\mathrm{SiO_2}$). All of them are characterized by high variability, 
often with right-skew. Calcium has a mean of 61.02 and a range of 4.00 to 
178.00. The maximum is three standard deviations above the mean. Magnesium has 
an average of 44.46 and a range of 0.10 to 293.00, with a maximum that is four 
standard deviations above the mean. Sodium has a high average of 447.09, and a 
high maximum of 2280.00, which is again three standard deviations above the 
mean. Potassium is not as elevated with a mean of 16.58, but it is still 
somewhat variable. Chloride has a particularly extreme maximum of 1560.00, 
which is five standard deviations above its mean of 108.70. Sulfate has a mean 
of 57.53 and a maximum of 486.00, which is four standard deviations above the 
mean. Bicarbonate has a very high mean of 1297.91, and the maximum reaches a 
staggering 3538.00. The last major ion is Silica, which has a mean of 38.73, but 
a range from 2.00 to 120.00. To summarize, the whole dataset show high 
variability and pervasive right-skewness. The chemical composition of the water
samples is largely dominated by bicarbonate, with sodium and chloride also 
reaching very high values for some samples.

```{r boxplots, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.asp=0.8}
# Select numeric features for scaling 
X <- data[, 3:14]                    #all numerical catergories
X <- as.data.frame(scale(X))         # z-scores per variable
X$.row <- 1:nrow(X)

# reshaping is to long for ggplot so use tidyr library
box_long <- pivot_longer(           #tidyr
  X,
  cols = - .row,
  names_to = "variable",
  values_to = "value"
)

# boxplots on a common axis (z-scored)
ggplot(box_long, aes(x = variable, y = value)) +
  geom_boxplot(notch = TRUE, outlier.alpha = 0.6, na.rm = TRUE) +
  coord_flip() +
  labs(x = NULL, y = "Scaled value (z-score)",
       title = "Fig. 1: Boxplots of all variables (z-scored) for Serbian spa waters") +
  theme(panel.grid.minor = element_blank())
```
Variables were standardised to z-scores to allow direct comparison despite 
differing measurement units. The boxplots (Fig. 1) show that some features 
(e.g. $\mathrm{Na^+}$, $\mathrm{Cl^-}$, $\mathrm{HCO_3^-}$) have greater 
variability and distinct outliers, while others remain tightly clustered around 
the mean. This highlights which chemical measures are most heterogeneous across 
the spa waters. However, all variables in the boxplot have a non-symmetrical 
shape and contain outliers, indicating that a log transformation is necessary.

```{r multivariate normal, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
# Fit MANOVA model using geoStruct as grouping
fit <- manova(as.matrix(X) ~ data$geoStruct)
# Extract residuals
res <- residuals(fit)
# Mahalanobis distances of residuals
mu_res <- colMeans(res)
S_res  <- cov(res)
d2_res <- mahalanobis(res, center = mu_res, cov = S_res)

# Degrees of freedom = number of variables
p <- ncol(res)

# QQ-plot
qqplot(qchisq(ppoints(nrow(res)), df = p), d2_res,
       main = "Fig. 2: QQ-plot of Serbian spa water MANOVA residuals",
       xlab = expression(paste(chi^2, " quantiles")),
       ylab = expression(paste("Ordered residual ", d[M]^2)))
abline(0,1,col="steelblue4")
```

The QQ-plot of MANOVA residual Mahalanobis distances against the theoretical 
$\chi^2$ distribution (Fig. 2) provides a diagnostic for assessing multivariate 
normality. If the residuals were perfectly normal, the points would lie close to 
the 45° line. In this case, the points deviate fairly evenly across the range of 
quantiles, rather than only at one end, indicating that the residuals are not an 
exact match to the multivariate Gaussian model. The upper tail in particular 
shows noticeable departures, with the largest residuals exceeding the expected 
$\chi^2$ quantiles, which indicates potential heavy-tailed behaviour or the 
presence of outliers. This means the assumption of multivariate normality is not 
fully satisfied.

```{r, echo=FALSE}
# Log transforming numeric variables and adding them into dataset as new columns
data$log.tempCels <- log(data$tempCels)
data$log.pH <- log(data$pH)
data$log.elec.Cond <- log(data$elecCond)
data$log.totSolid <- log(data$totSolid)
data$log.Ca2 <- log(data$Ca2)
data$log.Mg2 <- log(data$Mg2)
data$log.Na <- log(data$Na)
data$log.K <- log(data$K)
data$log.Cl <- log(data$Cl)
data$log.SO2 <- log(data$SO2)
data$log.HCO <- log(data$HCO)
data$log.SiO <- log(data$SiO)
```

After performing a log transformation of the variables, we recheck the 
univariate and multivariate normality of the data.

```{r echo=FALSE, warning=FALSE, message = FALSE}
X.log <- data[, 16:27]                    # all log transformed numerical variables
X.log <- as.data.frame(scale(X.log))         # z-scores per variable
X.log$.row <- 1:nrow(X.log)

box_long <- pivot_longer(           
  X.log,
  cols = - .row,
  names_to = "variable",
  values_to = "value"
)

# not z-scored
ggplot(box_long, aes(x = variable, y = value)) +
  geom_boxplot(notch = TRUE, outlier.alpha = 0.6, na.rm = TRUE) +
  coord_flip() +
  labs(x = NULL, y = "Scaled value (z-score)",
       title = "Fig. 3: Boxplots of log transformed Serbian spa water variables (z-scored)") +
  theme(panel.grid.minor = element_blank())
```

The boxplots (Fig. 3) are far more symmetric than with the untransformed data, showing
more conformity with the normal distribution. However, we can clearly see the
presence of outliers, particularly with the variable $\mathrm{Mg^{2+}}$, with
four observations at least 2 standard deviations below the mean.

```{r echo=FALSE}
X_log_matrix <- as.matrix(X.log[,-which(names(X.log) == ".row")]) # Remove the .row column for analysis

# Fit MANOVA model
fit_log <- manova(X_log_matrix ~ data$geoStruct)
res_log <- residuals(fit_log)

# Reusing Prev code
# Mahalanobis distances of residuals
mu_res_log <- colMeans(res_log)
S_res_log  <- cov(res_log)
d2_res_log <- mahalanobis(res_log, center = mu_res_log, cov = S_res_log)

# Degrees of freedom = number of variables
p <- ncol(res_log)

# QQ-plot
qqplot(qchisq(ppoints(nrow(res_log)), df = p), d2_res_log,
       main = "Fig. 4: QQ-plot of MANOVA (log transformed) residuals",
       xlab = expression(paste(chi^2, " quantiles")),
       ylab = expression(paste("Ordered residual ", d[M]^2)))
abline(0,1,col="steelblue4")
```

On the QQ plot for log transformed variables (Fig. 4), the points follow the 
line much more closely, with only slight deviations from the 
line at low and high values. The log transformed data much more closely 
follows a multivariate normal distribution.

```{r corrplot, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
cor_mat <- cor(X, use = "pairwise.complete.obs", method = "pearson")

# Define layout: 2 rows, 1 column — small top row for title
layout(matrix(c(1, 2), nrow = 2), heights = c(0.1, 0.9))

# Top row: title only
par(mar = c(0, 0, 1, 0))  # No margins except top
plot.new()
title("Fig. 5: Correlation Matrix of Serbian Spa Water Variables", cex.main = 1.2)

corrplot(
  cor_mat,
  method = "color",        
  type = "upper",          
  order = "hclust",        
  addCoef.col = "black",   
  number.cex = 0.7,        
  tl.col = "black",        
  tl.srt = 45,             
  diag = FALSE,
  col = colorRampPalette(c("firebrick3", "white", "steelblue4"))(200)
)

``` 

From the correlation matrix (Fig. 5), we can see that electrical conductivity, 
total solids, sodium, potassium, and chloride form a strongly correlated 
cluster, indicating they vary together across spa waters. In contrast, pH shows 
moderate negative correlations with several ions (e.g., C$\mathrm{Ca^{2+}}$, 
$\mathrm{Mg^{2+}}$, $\mathrm{HCO_3^-}$), suggesting different geochemical 
influences. Overall, the matrix highlights both tightly linked chemical groups 
and variables with weaker or opposing trends.


## PCA

```{r echo=FALSE, warning=FALSE, message=FALSE, PC-Elbow-Plot}

pca_fit <- prcomp(X_log_matrix, center=TRUE, scale. = TRUE) # apply pca on relevant explanatory numerical columns 

par(mar = c(5, 4, 4, 2) + 0.1)

# Plot PCA scree plot
plot(pca_fit, type = "l", main = "Fig. 6: PCA elbow plot for Serbian spa data")

```
```{r PCA-summary-table, echo=FALSE, message=FALSE, warning=FALSE}

# Extract summary and convert to data frame
pca_summary <- summary(pca_fit)$importance
pca_df <- as.data.frame(round(pca_summary, 4))  # Round for readability
pca_df <- t(pca_df)  # Transpose so PCs are rows

# Create clean table
kable(pca_df, caption =  "Summary of Principal Components", align = "c", format = "latex",
      booktabs = TRUE,
      longtable = FALSE) %>%
  kable_styling(latex_options = c("H"), full_width = FALSE, position = "center") %>%
kable_styling(full_width = FALSE, position = "center") %>%
row_spec(0, extra_css = "font-family: serif;") %>%
row_spec(1:nrow(pca_df), extra_css = "font-family: serif;") %>%
column_spec(1:ncol(pca_df), extra_css = "font-family: serif;") 

```

Moving on to PCA, we can see (Table 2) that PC1 explains a lot of the variance 
(around half, 48.41%). PC2 explains about a further fifth (17.94%). PC3 and PC4
explain a further 10.83% and 7.79% respectively, and these 4 PCs cumulatively
account for 84.97% of the overall variance. From PC5 and onwards, each PC 
explains less than 7% of the extra variance. The elbow plot (Fig.6) displays this 
flattening as the effect of each PC becomes smaller and smaller. It appears 
that using 4 Principal Components would be sufficient in the model.

```{r echo=FALSE}

loadings <- pca_fit$rotation

loadings_df <- as.data.frame(loadings)
loadings_df$Variable <- rownames(loadings_df)

loadings_df <- loadings_df[, c("Variable", paste0("PC", 1:4))]

rownames(loadings_df) <- NULL

knitr::kable(loadings_df, digits = 3, caption = "Serbian Spa Variable Influence on Principal Components", align = "c")%>%
  kable_styling(latex_options = "H", position = "center")

```


Table 3 displays the influence of individual variables on the four principal components. 
In PC1, $HCO_3^-$ (0.388), $Na^+$ (0.345), elecCond (0.378), $K^+$ (0.376), 
and totSolid(0.367) have the highest influence. PC1 strongly correlates with 
variables relating to major ions and total dissolved content. PC1 measures the 
overall mineralisation and ionisation levels of the water. Samples with high PC1 
scores have high mineralisation. In PC2, $Mg^{2+}$ (0.438), $Ca^{2+}$ (0.55), tempCels(-0.329), $SiO_2$(-0.352),
and $Na^+$ (-0.301), have the strongest influence. PC2 separates water with high 
calcium and magnesium (hardness) from waters at higher temperatures. This could 
mean that there is a difference between hard, cold waters and warmer waters. In PC3, $SO_2$ (0.717) and tempCels(0.521) have the strongest influence. Waters that have more sulfate are warmer. In PC4, $SiO_2$ (-0.611), $Cl^-$(0.676) and tempCels(0.302) have the strongest influence. Waters with higher chlorine levels have less silicone and are warmer.

## Surprising observations

```{r echo=FALSE}
# Standardise numeric variables
X <- scale(data[, 3:14])

# Find any rows with at least one variable > 3 sd away
outliers <- which(apply(abs(X), 1, max) > 3)

# Show these "surprising" sites
surprising_sites <- data[outliers, c("waterSource", "tempCels", "elecCond", "totSolid",
                 "Na", "Cl", "HCO")]

knitr::kable(surprising_sites,
             format = "latex",
             caption = "Water sources with at least one variable > 3 standard deviations from the mean",
             align = "c",
             digits = 2) %>%
  kable_styling(latex_options = "H", position = "center")
            
```

From the standardised $n=30$ observations, five springs are flagged as clear 
outliers (Table 4): Junakovic, Selters, Vranjska, Tulaska, and Veluce. Each of these sites 
has at least one measurement more than three standard deviations from the mean. 
Junakovic is extreme in electrical conductivity ($5100~\mu$S/cm) and total 
dissolved solids ($6.2$ g/L). Selters is distinguished by exceptionally high 
concentrations of sodium ($2280$ mg/L), chloride ($1560$ mg/L), and bicarbonate 
($3360$ mg/L). Vranjska stands out for its near-boiling temperature 
($95^\circ$C), while Tulaska and Veluce show unusually high bicarbonate levels 
relative to the rest of the dataset. These five cases are the most “surprising” 
when the dataset is examined variable by variable.

```{r echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Mahalanobis distances
mu <- colMeans(X)
S  <- cov(X)
d2 <- mahalanobis(X, center = mu, cov = S)
cut <- qchisq(0.95, df = ncol(X))
outliers <- d2 > cut

# Add to PCA plot data
pca_plot_data <- data.frame(
  PC1 = pca_fit$x[, 1],
  PC2 = pca_fit$x[, 2],
  Geological_Group = as.factor(data$geoStruct),
  Water_Source = data$waterSource,
  Outlier = outliers
)

# Plot
ggplot(pca_plot_data, aes(x = PC1, y = PC2, color = Geological_Group)) +
  geom_point(size = 4, alpha = 0.8) +
  # Highlight outliers
  geom_point(data = subset(pca_plot_data, Outlier), 
             aes(x = PC1, y = PC2), 
             shape = 21, fill = "yellow", color = "orange", size = 4, stroke = 1.2) +
  geom_text(data = subset(pca_plot_data, Outlier),
            aes(label = Water_Source),
            color = "black",
  size = 3.5, max.overlaps = 15, box.padding = 0.5, point.padding = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
  stat_ellipse(level = 0.95, alpha = 0.7) +  
  labs(
    title = "Fig. 7: PC2 vs PC1 with outliers",
    x = paste0("PC1 (", round(summary(pca_fit)$importance[2,1]*100, 1), "%)"),
    y = paste0("PC2 (", round(summary(pca_fit)$importance[2,2]*100, 1), "%)"),
    color = "Geological\nStructure"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "right")

```
Plotting the Mahalanobis distance against the first two principle components (Fig. 7)
gives a multivariate view of the outliers, in terms of their overall chemical
composition rather than a single variable. Using the Mahalanobis distance with
a 95% Chi-Squared significance, another five sites were identified as outliers-
these are the same five as previously identified as having extreme values for
individual variables, with the exception that Junakovic is no longer an outlier,
and Bujanovacka has replaced it.

```{r echo = FALSE}
outlier_table <- data.frame(
  Water_Source = data$waterSource[outliers],
  Geological_Group = data$geoStruct[outliers],
  Mahalanobis_Distance = round(d2[outliers], 2),
  PC1 = round(pca_fit$x[outliers, 1], 2),
  PC2 = round(pca_fit$x[outliers, 2], 2)
)

knitr::kable(
  outlier_table,
  caption = "Mahalanobis Outliers with PCA Scores",
  align = "c")%>%
  kable_styling(latex_options = "H", position = "center")
```


Along the first PC, Selters, Bujanovacka and Tularska score highly (Table 5). 
This indicates high mineralisation and ionisation in these samples, and is 
consistent with our earlier finding of Selters as having high concentrations 
of chloride, sodium, and bicarbonate and Tulaska with high concentrations of
sodium and bicarbonate. Veluce also scores highly on concentrations
of bicarbonate, giving it a relatively high score on PC1 but not as extreme.

Along PC2, Vranskja has a strong negative score. Temperature has a strong 
negative influence on PC2, and Vranskja stands out among the sites for its
extremely high temperature (near boiling, 95 $^{\circ}$C). 


```{r echo=FALSE}
# Filter for water source "bujanovacka"
bujanovacka_data <- subset(data, waterSource == "Bujanovacka", 
                           select = c("waterSource", "tempCels", "elecCond", 
                                      "totSolid", "Na", "Cl", "HCO"))

knitr::kable(
  bujanovacka_data,
  caption = "Water Quality Variables for Bujanovacka",
  align = "c"
) %>%
  kable_styling(latex_options = "H", position = "center")
```

The Bujanovacka site's high score in PC1 is explained by its high concentration
of Bicarbonate (3086 mg/L) and Sodium (2650 mg/L) (Table 6).


## Factor Analysis

Factor analysis is a model estimation which deals with the assumptions of 
underlying causal structure, whereas PCA was a data transformation.


```{r echo=FALSE, message=FALSE}
library(psych)
X.log <- X.log[, !names(X.log) == ".row"] # remove '.row' column

pvalues <- rep(0, 5) 
for(f in 1:5) {
  res <- try(factanal(X.log, factors = f), silent = TRUE) # get the p-values for each factor
  if(!inherits(res, "try-error")) {
    pvalues[f] <- res$PVAL
  }
}

ggplot(data.frame(Factors = 1:5, pvalues = pvalues), 
       aes(x = Factors, y = pvalues)) +
  geom_point(size = 3) +
  geom_line() +
  xlab("Number of Factors") +
  ylab("p-value") +
  labs(title = "Fig. 8: Factor Adequacy Test")
```
The p-values in Fig.8 check the following:
$H_0:$ k factors are sufficient\
$H_1:$ More than k factors are needed.

Therefore, 5 factors is sufficient as p-value is \> 0.05. 4 or less factors is 
not sufficient (p-values \< 0.03).

```{r warning=FALSE, message=FALSE, echo=FALSE}
# Run factor analysis
faresult <- factanal(X.log, factors = 5)

# Extract SS loadings (sum of squared loadings per factor)
ss_loadings <- colSums(as.matrix(faresult$loadings)^2)

# Calculate proportions and cumulative proportions
proportion_var <- ss_loadings / ncol(X.log)
cumulative_var <- cumsum(proportion_var)

# Combine into a matrix for display
stats_matrix <- rbind(
  "SS loadings"    = ss_loadings,
  "Proportion Var" = proportion_var,
  "Cumulative Var" = cumulative_var
)

# Round for readability
stats_matrix <- round(stats_matrix, 3)

# Assign column names like Factor1, Factor2, etc.
colnames(stats_matrix) <- paste0("Factor", seq_len(ncol(stats_matrix)))

knitr::kable(stats_matrix, "latex", booktabs = TRUE, caption = "Summary Statistics from Factor Analysis (5 Factors)") %>%
  kable_styling(latex_options = "hold_position")

```

We can see from Table 7 that Factor 5's loading is small (0.379), and only contributes 3.1% of the overall
variance. So we will go back to four factors, and visualize the result.

```{r echo=FALSE, fig.width=11.5, fig.align='center'}
# Set wider margins to avoid clipping (bottom, left, top, right)
par(mar = c(5, 9, 4, 2))  # Increase left margin

# Plot factor diagram
fa.diagram(faresult$loading[, 1:4], digits = 4, main = "")

# Add title
title(main = "Fig. 9: Factor analysis")
```

The red arrows in Fig. 9 indicate negative variables.

-   F1: Total Solid (+ 0.907), Electrical Conductivity (+ 0.90), Na (+ 0.85), HCO (+ 0.78), K (+ 0.72), 
SiO (+ 0.63).\
-   F2: Mg2 (+ 0.92), Ca2 (+ 0.85), pH (- 0.75), tempCels (- 0.32).\
-   F3: Cl (+ 0.93).\
-   F4: SO2 (+ 0.99).

Factor analysis selected 4 factors with 79% variance explained (Table 7), whereas PCA 
preferred 4 PCs with 85% variance explained. The factors show that there are 4 
water types:

-   F1: Highly mineralised waters (high soliditity and electrical conductivity)\
-   F2: Magenesium, Calcium (hardness ions), acidic and cool waters\
-   F3: Chloric waters.\
-   F4: Sulfate waters.

Factor analysis is better for model selection since it doesn't include noise 
like PCA (that's why PCA variance for 4 PCs was greater than FA 4 factors 
cumulative variance), and maintains parsimony. PCA had to consider all 12 
Principal Components, whereas FA only had to look at 5 or less factors for 
determining the underlying structure of spa water composition.

## geoStruct Groups

```{r}
# Check p value
summary(fit_log, test = "Hotelling-Lawley")
```
To assess whether the predefined geostructural groups are verified by the water 
chemistry data, we began with a formal test of multivariate mean differences. A 
MANOVA on the log-transformed variables produced a p-value of 0.057, which 
provides only weak evidence that the group mean vectors differ. This suggests 
that while some differences exist, they are not pronounced enough to be 
considered statistically significant at conventional levels.

```{r echo=FALSE}
lda_data <- data.frame(geoStruct = data$geoStruct, X_log_matrix)
lda_fit <- lda(geoStruct ~ ., data = lda_data)
lda_scores <- predict(lda_fit)$x

plot_data <- data.frame(lda_scores, Group = as.factor(lda_data$geoStruct))

ggplot(plot_data, aes(x = LD1, y = LD2, color = Group)) +
  geom_point(size = 3) +
  stat_ellipse(level = 0.95) +
  labs(title = "Fig. 10: Visual Check of Group Covariance",
       x = "Linear Discriminant 1",
       y = "Linear Discriminant 2") +
  theme_minimal()
```

After testing the assumptions of Linear Discriminant Analysis (LDA), it becomes 
clear that the method is not suitable for this dataset. The group covariance 
ellipses(Fig. 10) display different shapes and orientations, which indicates that the 
groups do not share a common covariance structure. Since LDA requires equal 
covariance matrices across classes, this assumption is violated and the method 
cannot be applied reliably.

```{r echo=FALSE}
library(e1071)
library(caret)
y  <- factor(data$geoStruct)
Xl <- scale(as.data.frame(X_log_matrix))
# Leave-One-Out Cross-Validation
n <- nrow(Xl); pred <- factor(rep(NA,n), levels=levels(y))
for(i in 1:n){
  fit_i <- naiveBayes(x=Xl[-i,], y=y[-i])
  pred[i] <- predict(fit_i, newdata=Xl[i,,drop=FALSE])
}
confusionMatrix(table(True=y, Pred=pred))

```

As an alternative, we adopted the Naive Bayes classifier. Unlike LDA, Naive 
Bayes does not require estimation of full covariance matrices and instead 
assumes conditional independence of the variables within each class. This makes 
it more appropriate for datasets with small and unbalanced groups such as ours, 
where some geostructural categories contained as few as five observations. We 
fitted the Naive Bayes model to the log-transformed variables and evaluated 
performance using leave-one-out cross-validation to provide a fair estimate of 
classification accuracy.

Although we did not have external prior probabilities for the geostructural 
categories, Naive Bayes estimates them from the observed class frequencies in 
the sample. This corresponds to assuming that the sample is representative of 
the population proportions. Alternatively, one could impose equal priors to 
reflect an uninformative prior belief. In either case, the classification rule 
remains valid, and our results reflect how well the chemical profiles align with
the predefined groups under these assumptions.

The model achieved an overall accuracy of 50 percent, which is higher than the 
no-information rate of 40 percent but still modest. The Kappa statistic of 0.29 
suggests only fair agreement between the predicted and true classes. The 
classification performance varied across groups. Karstic terrains (Class 2) and 
Metamorphic regions (Class 4) were the best recognised categories, with balanced 
accuracies of 0.81 and 0.74 respectively, indicating that their chemical 
profiles are relatively distinctive. Hydrological Basins (Class 1), on the other 
hand, were poorly distinguished and often misclassified as Volcanogen Massifs 
(Class 3). Volcanogen Massifs themselves, despite being the largest group, were 
only moderately well classified, with a balanced accuracy of 0.53.

These results suggest that the groups, the geostructural categories, are only 
partially verified by the data. Some groups do exhibit clear multivariate 
chemical signatures, allowing them to be separated reasonably well, while others 
show substantial overlap that prevents reliable classification. In particular, 
the difficulty in separating Hydrological Basins from Volcanogen Massifs implies
that the water chemistry of these groups is not sufficiently distinct. Overall, 
the analysis provides evidence that geological structure does influence chemical 
composition, but the effect is not strong enough across all groups for the 
classification to be considered fully verified. The geostructural groupings are 
therefore only partially confirmed by the data.

# **Conclusion**




