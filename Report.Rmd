---
title: "Serbian Spa Waters Report"
author: "[GUYS ADD YOUR NAMES AND STUDENT ID HERE], Leah Ye 300651931, Harry Philpott 300667756, Elizabeth Myers 300641471"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(knitr)
library(GGally)
library(ggplot2)
library(tidyr)
library(corrplot)
library(kableExtra)
library(wesanderson)
```

# **Introduction & Background** - Liz

This study analyzed hydrochemical data for mineral and thermal waters in Serbian territory. The authors used principal component analysis (PCA) and hierarchical cluster analysis (HCA) to characterize the chemical composition and natural radioactivity of these water samples, understand the relationships between the variables measured, and classify the waters with respect to their geotectonic units. PCA revealed four latent factors that accounted for 74.2% of the variability among the observations. Two of these four PCs are based on measures of mineralization of the components of the host rock, and the other two are based on variables that are indicative of natural radioactivity. The results achieved a total correct classification of 83.3% for predefined geotectonic units, and the dendogram produced classified the samples into four major groups and eleven subgroups.

# **Descriptive analysis of the data** - Leah

The Serbian Spa Waters Dataset contains 30 observations(sites), with 15 columns:

-   idNum: Integer - Index of each observation;\
-   waterSource: Character - Spa/Spring the observation belongs to;\
-   tempCels: Numerical - Outflowing temperature (°C);
-   pH: Numerical - pH level(Acidity/Alkalinity);\
-   elecCond: Integer - Electrical Conductivity of water measured immediately after collection on the spot, total ion concentration (μS/cm);\
-   totSolid: Numerical - Total dissolved solids (gL)
-   Ca2: Numerical - Calcium (mg/L);\
-   Mg2: Numerical - Magnesium (mg/L);\
-   Na: Numerical - Sodium (mg/L);\
-   K: Numerical - Potassium (mg/L);\
-   Cl: Numerical - Chlorine (mg/L);\
-   S02: Numerical - Sulfate (mg/L);\
-   HCO: Numerical - Bicarbonate (mg/L);\
-   Si0: Numerical - Silica, dissolved silicon dioxide (mg/L);\
-   geoStruct: Integer - The geological structure the water was collected from (1 = Hydrological Basin, 2 = Karstic terrains, 3 = Volcanogen Massifs, 4 = Metamorphic Regions)

Where Ions$(HCO_3^−, Ca^{2+}, Mg^{2+}, Na^+, K^+, Cl^−, SO^{2−}_4, SiO_2)$ were analysed in the laboratories of Institute of Public Health of Serbia. Titration methods were applied to measure alkalinity of $Ca^{2+}$ and $Mg^{2+}$. Concentrations of $Na^+$ and $K^+$ were determined by atomic absorption spectrophotometry.

Where Hyodrological Basins and Karstic terrains have 5 observations each, Volcanogen Massifs has 14 observations, and Metamorphic Regions has 6 observations. This is an unbalanced dataset since there are varying observations per group.

There are no duplicates, missing data, zeros, negatives, NAs or NULL values in the dataset.

## **Summary Statistics** - Liz

```{r echo=FALSE}
data <- read.csv("serbianspawater.csv")
```

```{r}
# Select numeric columns
numeric_cols <- data[sapply(data, is.numeric) & !(names(data) %in% c("idNum", "geoStruct"))]

# Create summary table
summary <- data.frame(
  Variable = names(numeric_cols),
  Mean     = round(sapply(numeric_cols, mean), 2),
  Median   = round(sapply(numeric_cols, median), 2),
  SD       = round(sapply(numeric_cols, sd), 2),
  Min      = round(sapply(numeric_cols, min), 2),
  Max      = round(sapply(numeric_cols, max), 2),
  row.names = NULL
)

# Format summary to show two decimal places
summary_formatted <- summary
summary_formatted[, 2:6] <- lapply(summary[, 2:6], function(x) sprintf("%.2f", x))

# Display table
kable(summary_formatted, caption = "Summary Statistics for Numeric Columns", align = c("l", "r", "r", "r", "r", "r")) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  row_spec(0, extra_css = "font-family: serif;") %>%  
  column_spec(1:ncol(summary), extra_css = "font-family: serif;")  
```

This dataset is characterized by high variability. This is likely due to the different water sources. pH is more consistent, ranging from neutral (6.5) to slightly basic (9.0), which are fairly typical values for water in nature. The range of temperatures recorded in this dataset is from 14.40 to 95.00 degrees celcius. The large standard deviation confirms that there is a lot of variability in temperature. Some of these water sources are near boiling temperatures. Electrical conductivity also has a very large range, from 110.00 to 5100.00 $\mu$S/cm. This indicates that some water samples have a lot of dissolved ions, leading to high conductivity. This measure is roughly proportional to the total dissolved solids, which also displays a large range, from 0.10 to 6.20. The maximum is more than three standard deviations above the mean, suggesting right-skew and surprising observations. There are eight major ions in this dataset: Calcium ($Ca^{2+}$), Magnesium ($Mg^{2+}$), Sodium (\$Na\^+ $), Potassium ($K^+^$), Chloride ($CI-$), Sulfate ($SO\^{-2}\_4$), Bicarbonate ($HCO\^-\_3$), and Silica ($SiO_2\$). All of them are characterized by high variability, often with right-skew. Calcium has a mean of 61.02 and a range of 4.00 to 178.00. The maximum is three standard deviations above the mean. Magnesium has an average of 44.46 and a range of 0.10 to 293.00, with a maximum that is four standard deviations above the mean. Sodium has a high average of 447.09, and a high maximum of 2280.00, which is again three standard deviations above the mean. Potassium is not as elevated with a mean of 16.58, but it is still somewhat variable. Chloride has a particularly extreme maximum of 1560.00, which is five standard deviations above its mean of 108.70. Sulfate has a mean of 57.53 and a maximum of 486.00, which is four standard deviations above the mean. Bicarbonate has a very high mean of 1297.91, and the maximum reaches a staggering 3538.00. The last major ion is Silica, which has a mean of 38.73, but a range from 2.00 to 120.00. To summarize, the whole dataset show high variability and pervasive right-skewness. The chemical composition of the water samples is largely dominated by bicarbonate, with sodium and chloride also reaching very high values for some samples.

# **Graphical analysis**

## Pairs Plot - Liz

```{r pairs_plot2, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.width=16, fig.height=16, dpi=150, out.width='100%'}

pairs_plot <- ggpairs(
  numeric_cols,
  
  upper = list(
    continuous = wrap(
      "cor",
      size = 5,
      color = "black",
      alignPercent = 0.9,
      theme = theme_void() 
    )
  ),
  
  lower = list(
    continuous = wrap(
      "points",
      alpha = 0.6,
      size = 1.5,
      # theme specifically for lower panels
      theme = theme(
        panel.background = element_rect(fill = "white"),
        panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_line(color = "grey90", size = 0.3),
        panel.grid.minor = element_blank()
      )
    )
  ),
  
  diag = list(
    continuous = wrap(
      "densityDiag",
      alpha = 0.4,
      fill = "#046C9A",
      # clean theme
      theme = theme(
        panel.background = element_rect(fill = "white"),
        panel.border = element_rect(color = NA),
        panel.grid = element_blank()
      )
    )
  )
) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),
    strip.text  = element_text(size = 14, color = "black"),
    strip.background = element_rect(fill = "white", color = NA)
  )

pairs_plot

# Save as PNG
ggsave(
  "full_pairs_plot_points_bigger_final.png", 
  plot = pairs_plot, 
  width = 25, 
  height = 25, 
  units = "in", 
  dpi = 300
)
```

- All histograms show non-normality (not bell shaped)

## Box Plot - Harry

```{r boxplots, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.asp=0.8}
# Select numeric features for scaling 
X <- data[, 3:14]                    #all numerical categories
X <- as.data.frame(scale(X))         # z-scores per variable
X$.row <- 1:nrow(X)

# reshaping is to long for ggplot so use tidyr library
box_long <- pivot_longer(           #tidyr
  X,
  cols = - .row,
  names_to = "variable",
  values_to = "value"
)

colors <- c(
  wes_palette("Darjeeling1"),     
  wes_palette("FantasticFox1"),
  wes_palette("Darjeeling2")    
)

colors <- colors[1:12]

# boxplots on a common axis (z-scored)

ggplot(box_long, aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(notch = TRUE, outlier.alpha = 0.6, na.rm = TRUE) +
  coord_flip() +
  scale_fill_manual(values = colors) + 
  labs(x = NULL, y = "Scaled value (z-score)",
       title = "Serbian Spa Waters: Boxplots of All Variables (Z-scored)") +
  theme_minimal(base_family = "Times New Roman") + 
  theme(
    panel.grid.major = element_line(color = "grey80", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 16),
    axis.text = element_text(size = 12),
    legend.position = "none"
  )
```

Variables were standardised to z-scores to allow direct comparison despite differing measurement units. The boxplots show that some features (e.g. Na⁺, Cl⁻, HCO₃⁻) have greater variability and distinct outliers, while others remain tightly clustered around the mean. This highlights which chemical measures are most heterogeneous across the spa waters.

However, all variables in the boxplot have a non-symmetrical shape and contain outliers. This violates the LDA assumption of normality so log transformation of explanatory variables is needed.

# Multivariate Normal - Harry

```{r multivariate normal, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
# Fit MANOVA model using geoStruct as grouping
fit <- manova(as.matrix(X) ~ data$geoStruct)
# Extract residuals
res <- residuals(fit)
# Mahalanobis distances of residuals
mu_res <- colMeans(res)
S_res  <- cov(res)
d2_res <- mahalanobis(res, center = mu_res, cov = S_res)

# Degrees of freedom = number of variables
df <- ncol(res)

# QQ-plot
par(family = "serif")
qqplot(qchisq(ppoints(nrow(res)), df = df), d2_res,
       main = "QQ-plot of MANOVA residuals",
       xlab = expression(paste(chi^2, " quantiles")),
       ylab = expression(paste("Ordered residual ", d[M]^2)))
abline(0,1,col="#046C9A")
```

The QQ-plot of MANOVA residual Mahalanobis distances against the theoretical $\chi^2$ distribution provides a diagnostic for assessing multivariate normality. If the residuals were perfectly normal, the points would lie close to the 45° line. In this case, the points deviate fairly evenly across the range of quantiles, rather than only at one end, indicating that the residuals are not an exact match to the multivariate Gaussian model. The upper tail in particular shows noticeable departures, with the largest residuals exceeding the expected $\chi^2$ quantiles, which indicates potential heavy-tailed behaviour or the presence of outliers. Strictly speaking, this means the assumption of multivariate normality is not fully satisfied. Nevertheless, since most observations adhere reasonably closely to the expected distribution, it is common in practice to proceed under the approximate normality assumption while acknowledging these limitations and interpreting MANOVA results with some caution.

```{r}
# Check p value
summary(fit, test = "Hotelling-Lawley")
```

-   Extremely small p-value indicates there is significant differences between mean vectors of the geoStruc groups.

# Log transformation of variables - Leah

```{r}
# Log transforming numeric variables and adding them into dataset as new columns
data$log.tempCels <- log(data$tempCels)
data$log.pH <- log(data$pH)
data$log.elec.Cond <- log(data$elecCond)
data$log.totSolid <- log(data$totSolid)
data$log.Ca2 <- log(data$Ca2)
data$log.Mg2 <- log(data$Mg2)
data$log.Na <- log(data$Na)
data$log.K <- log(data$K)
data$log.Cl <- log(data$Cl)
data$log.SO2 <- log(data$SO2)
data$log.HCO <- log(data$HCO)
data$log.SiO <- log(data$SiO)
```

## Recheck assumptions - Leah

### Multivariate normal assumptions check

1.  Check univariate normality for each variable

```{r echo=FALSE, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
X.log <- data[, 16:27]                    # all log transformed numerical variables
X.log <- as.data.frame(scale(X.log))         # z-scores per variable
X.log$.row <- 1:nrow(X.log)

box_long <- pivot_longer(           
  X.log,
  cols = - .row,
  names_to = "variable",
  values_to = "value"
)

# not z-scored
ggplot(box_long, aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(notch = TRUE, outlier.alpha = 0.6, na.rm = TRUE) +
  coord_flip() +
  scale_fill_manual(values = colors) + 
  labs(x = NULL, y = "Scaled value (z-score)",
       title = "Serbian Spa Waters: Boxplots of All Log Transformed Variables (Z-scored)") +
  theme_minimal(base_family = "Times New Roman") + 
  theme(
    panel.grid.major = element_line(color = "grey80", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 16),
    axis.text = element_text(size = 12),
    legend.position = "none"
  )
```

-   Boxplots look much better than before\
-   The medians are approximately at 0, and plots are much more symmetric.\
-   However, there are some outliers (more than 2 standard deviations above and below the mean).

```{r}
par(mfrow = c(3, 4)) # Arrange plots in a 3x4 grid for 12 variables
X.log <- X.log[, !names(X.log) == ".row"] # remove '.row' column

for (i in 1:ncol(X.log)) {
  qqnorm(X.log[, i], main = names(X.log)[i])
  qqline(X.log[, i], col = "red")
}
```

p-value \> 0.05 suggests normality

2.  Check Multivariate normality (Linear combinations)

```{r echo=FALSE}
X_log_matrix <- as.matrix(X.log)

# Fit MANOVA model
fit_log <- manova(X_log_matrix ~ data$geoStruct)
res_log <- residuals(fit_log)

# Reusing Prev code
# Mahalanobis distances of residuals
mu_res_log <- colMeans(res_log)
S_res_log  <- cov(res_log)
d2_res_log <- mahalanobis(res_log, center = mu_res_log, cov = S_res_log)

# Degrees of freedom = number of variables
p <- ncol(res_log)

# QQ-plot
qqplot(qchisq(ppoints(nrow(res_log)), df = p), d2_res_log,
       main = "QQ-plot of MANOVA (log transformed) residuals",
       xlab = expression(paste(chi^2, " quantiles")),
       ylab = expression(paste("Ordered residual ", d[M]^2)))
abline(0,1,col="steelblue4")
```

-   The points follow the line much more closely, only slight deviations from the line at low and high values.

```{r}
# Check p value
summary(fit_log, test = "Hotelling-Lawley") # If anyone remembers the actual test please update it in the code cuz i forgot which one it is
```

-   P-value is 0.05712, so there is not enough evidence to conclude that the multivariate means of geoStruc groups are statistically different from each other.

**Multivariate Normality assumptions are satisfied**\

1. Each variable is normally distributed(univariate normality), and\
2. Each linear combination of the variables is normally distributed

### Linear Discriminant analysis checking

1.  Check classes are linearly separable

```{r}
pca_result <- prcomp(X.log, scale. = TRUE)
pca_scores <- as.data.frame(pca_result$x)
pca_scores$geoStruct <- data$geoStruct # Add group labels

# Plot first two PCs colored by group
ggplot(pca_scores, aes(x = PC1, y = PC2, color = factor(geoStruct))) +
  geom_point(size = 3) +
  stat_ellipse(level = 0.95) + # Adds confidence ellipses
  labs(title = "PCA: Checking Linear Separability",
       color = "Geological\nStructure") +
  theme_minimal()
```

-   Groups seems to be intermingled, and there is no Linear Separability\

2.  Check Equality of Covariance Matrices

```{r warning=FALSE, message=FALSE}
library(biotools)
# Box's M Test
boxM_result <- boxM(X_log_matrix, group = as.factor(data$geoStruct))
boxM_result
```

-   Small sample size of each group so Box's M test is not possible to use. So a visual LDA plot check is needed.

```{r}
lda_data <- data.frame(geoStruct = data$geoStruct, X_log_matrix)
lda_fit <- lda(geoStruct ~ ., data = lda_data)
lda_scores <- predict(lda_fit)$x

plot_data <- data.frame(lda_scores, Group = as.factor(lda_data$geoStruct))

ggplot(plot_data, aes(x = LD1, y = LD2, color = Group)) +
  geom_point(size = 3) +
  stat_ellipse(level = 0.95) +
  labs(title = "LDA: Visual Check of Group Covariance",
       subtitle = "Similar ellipse shapes & orientations suggest similar covariance",
       x = "Linear Discriminant 1",
       y = "Linear Discriminant 2") +
  theme_minimal()
```

We can see from the LDA plot distinct shapes and orientations in ellipses representing the covariance of the groups. While the centers are separated, the ellipses overlap. 

Given the clear differences between these groups, the covariance matrices of the groups cannot be equal and LDA is not appropriate for this data. The assumption of equal covariance is clearly failed when looking at the distinction in the shape and orientation between each group.

## Correlation matrix - Harry

```{r corrplot, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
par(family = "serif")
cor_mat <- cor(X, use = "pairwise.complete.obs", method = "pearson")
corrplot(cor_mat,
         method = "color",        
         type = "upper",          
         order = "hclust",        
         addCoef.col = "black",   
         number.cex = 0.7,        
         tl.col = "black",        
         tl.srt = 45,             
         diag = FALSE, 
         col = colorRampPalette(c("#046C9A","white","#FD6467"))(200)
)
```

Electrical conductivity, total solids, sodium, potassium, and chloride form a strongly correlated cluster, indicating they vary together across spa waters. In contrast, pH shows moderate negative correlations with several ions (e.g., Ca²⁺, Mg²⁺, HCO₃⁻), suggesting different geochemical influences. Overall, the matrix highlights both tightly linked chemical groups and variables with weaker or opposing trends.


## PCA - Leah

```{r echo=FALSE, warning=FALSE, message=FALSE, PC-Elbow-Plot, fig.cap="Figure 4: PCA plot", fig.asp=0.8}
library(plotly)
pca_fit <- prcomp(X_log_matrix, center=TRUE, scale. = TRUE) # apply pca on relevant explanatory numerical columns 
plot(pca_fit, type="l")
```

-   PC1 explains most of the variance (around 4)\
-   PC2 explains a fair part of the variance
-   At PC3 and 4, the extra variance explained is a bit less\
-   From PC4, the line starts to flatten\
-   Each additional component after PC4 only adds a tiny bit of variance.

```{r echo=FALSE, PC-Summary-tab}
summary(pca_fit)
```

-   PC1 has a standard deviation of 2.41, and explains 48.4% of the variance
-   PC2 adds 17.9%, and explains 66.4% of the variance
-   PC3 adds 10.8%, and explains 77.2% of the variance
-   PC4 adds 7.79%, and explains 84.97% of the variance
-   From PC5 and onwards, each PC explains less than 7% of the extra variance

Using 4 Principal Components would be sufficient in the model.

```{r}
pca_fit
```

-   In PC1, $HCO_3^-(0.388), Na^+(0.345), elecCond(0.378), K^+(0.376), totSolid(0.367)$ have the highest influence. PC1 strongly correlates with variables relating to major ions and total dissolved content. PC1 measures the overall mineralisation and ionisation levels of the water. Samples with high PC1 scores have high mineralisation.
-   PC2: $Mg^{2+}(0.438), Ca^{2+}(0.55), tempCels(-0.329), SiO_2(-0.352,), Na^+(-0.301)$, have the strongest influence. PC2 separates water with high Calcium and Magnesium(hardness) from waters at higher temperatures. This could mean that there is a difference between hard, cold waters and warmer waters.\
-   PC3: $SO_2(0.717), tempCels(0.521)$ have the strongest influence. Waters that have more Sulfate are warmer.\
-   PC4: $SiO_2(-0.611), Cl^−(0.676), tempCels(0.302)$ have the strongest influence. Waters with higher chlorine levels have less Silicone and are warmer.

# Surprising Observations

```{r}
# Standardise numeric variables
X <- scale(data[, 3:14])

# Find any rows with at least one variable > 3 sd away
outliers <- which(apply(abs(X), 1, max) > 3)

# Show these "surprising" sites
data[outliers, c("waterSource", "tempCels", "elecCond", "totSolid",
                 "Na", "Cl", "HCO")]

# Multivariate check: Mahalanobis distances
mu <- colMeans(X)
S  <- cov(X)
d2 <- mahalanobis(X, center = mu, cov = S)

# Flag all sites with distance above the chi-square 99.9% cutoff
cut <- qchisq(0.999, df = ncol(X))
which(d2 > cut)
data[d2 > cut, c("waterSource", "tempCels", "elecCond", "totSolid",
                 "Na", "Cl", "HCO")]

# PCA on the log-transformed variables (already created earlier)
pca_result <- prcomp(X_log_matrix, scale. = TRUE)

# Get the scores for the first two PCs
scores <- as.data.frame(pca_result$x)
scores$waterSource <- data$waterSource
scores$geoStruct <- as.factor(data$geoStruct)

pca_plot_data <- data.frame(
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  Geological_Group = as.factor(data$geoStruct),
  Water_Source = data$waterSource 
)

# PC2 vs PC1
ggplot(pca_plot_data, aes(x = PC1, y = PC2, color = Geological_Group)) +
  geom_point(size = 4, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
  stat_ellipse(level = 0.95, alpha = 0.7) +  
  labs(
    title = "PCA: PC2 vs PC1",
    x = paste0("PC1 (", round(summary(pca_result)$importance[2,1]*100, 1), "%)"),
    y = paste0("PC2 (", round(summary(pca_result)$importance[2,2]*100, 1), "%)"),
    color = "Geological\nStructure"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "right")
```

From the standardised $n=30$ observations, five springs are flagged as clear outliers: Junakovic, Selters, Vranjska, Tulaska, and Veluce. Each of these sites has at least one measurement more than three standard deviations from the mean. Junakovic is extreme in electrical conductivity ($5100~\mu$S/cm) and total dissolved solids ($6.2$ g/L). Selters is distinguished by exceptionally high concentrations of sodium ($2280$ mg/L), chloride ($1560$ mg/L), and bicarbonate ($3360$ mg/L). Vranjska stands out for its near-boiling temperature ($95^\circ$C), while Tulaska and Veluce show unusually high bicarbonate levels relative to the rest of the dataset. These five cases are the most “surprising” when the dataset is examined variable by variable.

The PCA score plot gives a multivariate view, showing which sites are extreme in terms of their overall chemical profiles rather than a single ion. Along the first principal component (PC1, representing overall mineralisation), Ribarska and Prolom score strongly negative, indicating highly mineralised waters, while Kanjiža lies on the opposite end with a very dilute profile. Along the second principal component (PC2, contrasting hardness with temperature/pH), Vuča sits at the upper extreme with unusually high hardness, whereas Prolom and Ribarska again fall at the lower end, consistent with warmer, more alkaline waters. Thus, while the z-score analysis highlights individual extremes, the PCA identifies different sites as “surprising” because of their distinctive multivariate signatures.

-   Groups 1(Hydrological Basin), 2(Karstic terrains), and 4(Metamorphic Regions) have clusters within Group 3(Volcanogen Massifs).
-   Group 2 has the smallest cluster within Group 3.\
-   Group 1 and 4(small cluster) overlap within Group 3.\
-   Group 3's cluster is a wide spread.

# Factor Analysis

Factor analysis is a model estimation which deals with the assumptions of underlying causal structure, whereas PCA is a data transformation.

Assumptions:\
\* Covariation in the observed variables is due to the presence of one or more factors (latent variables) that exert causal influence on these observed variables.

PCA does not make such assumptions but both PCA and FA do not have a dependent variable to be explained by independent variables.

Hypotheses: There are unobserved variables that explain the observations.

```{r}
library(psych)
X.log <- X.log[, !names(X.log) == ".row"] # remove '.row' column

pvalues <- rep(0, 5) 
for(f in 1:5) {
  res <- try(factanal(X.log, factors = f), silent = TRUE) # get the p-values for each factor
  if(!inherits(res, "try-error")) {
    pvalues[f] <- res$PVAL
  }
}

ggplot(data.frame(Factors = 1:5, pvalues = pvalues), 
       aes(x = Factors, y = pvalues)) +
  geom_point(size = 3) +
  geom_line() +
  xlab("Number of Factors") +
  ylab("p-value") +
  labs(title = "Factor Adequacy Test")
```

$H_0:$ k factors are sufficient\
$H_1:$ More than k factors are needed

5 factors is sufficient as p-value is \> 0.05. 4 or less factors is not sufficient (p-values \< 0.03).

```{r warning=FALSE, message=FALSE}
faresult <- factanal(X.log, factors=5)
faresult
```

Factor 5 explains 82.4% of the total variance. Factor 5's loading is small (0.379). So we will go back to four factors, and visualize the result.

```{r}
fa.diagram(faresult$loadings, digits=4)
```

The red arrows indicate negative variables.

-   F1: Total Solid (+), Electrical Conductivity (+), Na (+), HCO (+), K (+), SiO (+).\
-   F2: Mg2 (+), Ca2 (+), pH (-), tempCels (-).
-   F3: Cl (+).\
-   F4: SO2 (+).

Factor analysis selected 4 factors with 79% variance explained. Whereas PCA preferred 4 PCs with 85% variance explained. The factors show that there are 4 water types:

-   F1: Highly mineralised waters (high soliditity and electrical conductivity)\
-   F2: Magenesium, Calcium (hardness ions), acidic and cool waters\
-   F3: Chloric waters.\
-   F4: Sulfate waters.

Factor analysis is better for model selection since it doesn't include noise like PCA (that's why PCA variance for 4 PCs was greater than FA 4 factors cumulative variance), and maintains parsimony. PCA had to consider all 12 Principal Components, whereas FA only had to look at 5 or less factors for determining the underlying structure of spa water composition.

# geoStruct groups
```{r}
library(e1071)
library(caret)
y  <- factor(data$geoStruct)
Xl <- scale(as.data.frame(X_log_matrix))
# Leave-One-Out Cross-Validation
n <- nrow(Xl); pred <- factor(rep(NA,n), levels=levels(y))
for(i in 1:n){
  fit_i <- naiveBayes(x=Xl[-i,], y=y[-i])
  pred[i] <- predict(fit_i, newdata=Xl[i,,drop=FALSE])
}
confusionMatrix(table(True=y, Pred=pred))

```

To assess whether the predefined geostructural groups are verified by the water chemistry data, we began with a formal test of multivariate mean differences. A MANOVA on the log-transformed variables produced a p-value of 0.057, which provides only weak evidence that the group mean vectors differ. This suggests that while some differences exist, they are not pronounced enough to be considered statistically significant at conventional levels.

After testing the assumptions of Linear Discriminant Analysis (LDA), it became clear that the method was not suitable for this dataset. The group covariance ellipses displayed different shapes and orientations, which indicated that the groups did not share a common covariance structure. Since LDA requires equal covariance matrices across classes, this assumption was violated and the method could not be applied reliably.

As an alternative, we adopted the Naive Bayes classifier. Unlike LDA, Naive Bayes does not require estimation of full covariance matrices and instead assumes conditional independence of the variables within each class. This makes it more appropriate for datasets with small and unbalanced groups such as ours, where some geostructural categories contained as few as five observations. We fitted the Naive Bayes model to the log-transformed variables and evaluated performance using leave-one-out cross-validation to provide a fair estimate of classification accuracy.

Although we did not have external prior probabilities for the geostructural categories, Naive Bayes estimates them from the observed class frequencies in the sample. This corresponds to assuming that the sample is representative of the population proportions. Alternatively, one could impose equal priors to reflect an uninformative prior belief. In either case, the classification rule remains valid, and our results reflect how well the chemical profiles align with the predefined groups under these assumptions.

The model achieved an overall accuracy of 50 percent, which is higher than the no-information rate of 40 percent but still modest. The Kappa statistic of 0.29 suggests only fair agreement between the predicted and true classes. The classification performance varied across groups. Karstic terrains (Class 2) and Metamorphic regions (Class 4) were the best recognised categories, with balanced accuracies of 0.81 and 0.74 respectively, indicating that their chemical profiles are relatively distinctive. Hydrological Basins (Class 1), on the other hand, were poorly distinguished and often misclassified as Volcanogen Massifs (Class 3). Volcanogen Massifs themselves, despite being the largest group, were only moderately well classified, with a balanced accuracy of 0.53.

These results suggest that the groups, the geostructural categories, are only partially verified by the data. Some groups do exhibit clear multivariate chemical signatures, allowing them to be separated reasonably well, while others show substantial overlap that prevents reliable classification. In particular, the difficulty in separating Hydrological Basins from Volcanogen Massifs implies that the water chemistry of these groups is not sufficiently distinct. Overall, the analysis provides evidence that geological structure does influence chemical composition, but the effect is not strong enough across all groups for the classification to be considered fully verified. The geostructural groupings are therefore only partially confirmed by the data.


