---
title: "Serbian Spa Waters Report"
author: "[GUYS ADD YOUR NAMES AND STUDENT ID HERE], Leah Ye 300651931, Harry Philpott 300667756"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(knitr)
library(GGally)
library(ggplot2)
library(tidyr)
library(corrplot)
library(kableExtra)
```


# **Introduction & Background** - Liz

Hydrochemical data for the mineral and thermal waters studied on Serbian territory.

# **Descriptive analysis of the data** - Leah

The Serbian Spa Waters Dataset contains 30 observations(sites), with 15 columns:  

* idNum: Integer - Index of each observation;  
* waterSource: Character - Spa/Spring the observation belongs to;     
* tempCels: Numerical - Outflowing temperature (°C);
* pH: Numerical - pH level(Acidity/Alkalinity);  
* elecCond: Integer - Electrical Conductivity of water measured immediately after collection on the spot, total ion concentration (μS/cm);   
* totSolid: Numerical - Total dissolved solids (gL)
* Ca2: Numerical -  Calcium (mg/L);  
* Mg2: Numerical - Magnesium (mg/L);    
* Na: Numerical - Sodium (mg/L);   
* K: Numerical - Potassium (mg/L);   
* Cl: Numerical - Chlorine (mg/L);  
* S02: Numerical - Sulfate (mg/L);   
* HCO: Numerical - Bicarbonate (mg/L);    
* Si0: Numerical - Silica, dissolved silicon dioxide (mg/L);    
* geoStruct: Integer - The geological structure the water was collected from (1 = Hydrological Basin, 2 = Karstic terrains, 3 = Volcanogen Massifs, 4 = Metamorphic Regions)

Where Ions$(HCO_3^−, Ca^{2+}, Mg^{2+}, Na^+, K^+, Cl^−, SO^{2−}_4, SiO_2)$ were analysed in the laboratories of Institute of Public Health of Serbia. Titration methods were applied to measure alkalinity of $Ca^{2+}$ and $Mg^{2+}$. Concentrations of $Na^+$ and $K^+$ were determined by atomic absorption spectrophotometry.  

Where Hyodrological Basins and Karstic terrains have 5 observations each, Volcanogen Massifs has 14 observations, and Metamorphic Regions has 6 observations.  

There are no duplicates, missing data, zeros, negatives, NAs or NULL values in the dataset. 

## **Summary Statistics** - Liz

```{r echo=FALSE}
data <- read.csv("serbianspawater.csv")
```

```{r}
# Select numeric columns
numeric_cols <- data[sapply(data, is.numeric) & !(names(data) %in% c("idNum", "geoStruct"))]

# Create summary table
summary <- data.frame(
  Variable = names(numeric_cols),
  Mean     = round(sapply(numeric_cols, mean), 2),
  Median   = round(sapply(numeric_cols, median), 2),
  SD       = round(sapply(numeric_cols, sd), 2),
  Min      = round(sapply(numeric_cols, min), 2),
  Max      = round(sapply(numeric_cols, max), 2),
  row.names = NULL
)

# Format summary to show two decimal places
summary_formatted <- summary
summary_formatted[, 2:6] <- lapply(summary[, 2:6], function(x) sprintf("%.2f", x))

# Display table
kable(summary_formatted, caption = "Summary Statistics for Numeric Columns", align = c("l", "r", "r", "r", "r", "r")) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  row_spec(0, extra_css = "font-family: serif;") %>%  
  column_spec(1:ncol(summary), extra_css = "font-family: serif;")  
```

This dataset is characterized by high variability.  This is likely due to the different water sources. pH is more consistent, ranging from neutral (6.5) to slightly basic (9.0), which are fairly typical values for water in nature. The range of temperatures recorded in this dataset is from 14.40 to 95.00 degrees celcius.  The large standard deviation confirms that there is a lot of variability in temperature.  Some of these water sources are near boiling temperatures.  Electrical conductivity also has a very large range, from 110.00 to 5100.00 $\mu$S/cm. This indicates that some water samples have a lot of dissolved ions, leading to high conductivity.  This measure is roughly proportional to the total dissolved solids, which also displays a large range, from 0.10 to 6.20. The maximum is more than three standard deviations above the mean, suggesting right-skew and surprising observations. There are eight major ions in this dataset: Calcium ($Ca^{2+}$), Magnesium ($Mg^{2+}$), Sodium ($Na^+ $), Potassium ($K^+$), Chloride ($CI^-$), Sulfate ($SO^{-2}_4$), Bicarbonate ($HCO^-_3$), and Silica ($SiO_2$).  All of them are characterized by high variability, often with right-skew. Calcium has a mean of 61.02 and a range of 4.00 to 178.00. The maximum is three standard deviations above the mean. Magnesium has an average of 44.46 and a range of 0.10 to 293.00, with a maximum that is four standard deviations above the mean. Sodium has a high average of 447.09, and a high maximum of 2280.00, which is again three standard deviations above the mean.  Potassium is not as elevated with a mean of 16.58, but it is still somewhat variable.  Chloride has a particularly extreme maximum of 1560.00, which is five standard deviations above its mean of 108.70.  Sulfate has a mean of 57.53 and a maximum of 486.00, which is four standard deviations above the mean.  Bicarbonate has a very high mean of 1297.91, and the maximum reaches a staggering 3538.00. The last major ion is Silica, which has a mean of 38.73, but a range from 2.00 to 120.00.  To summarize, the whole dataset show high variability and pervasive right-skewness.  The chemical composition of the water samples is largely dominated by bicarbonate, with sodium and chloride also reaching very high values for some samples. 

# **Graphical analysis** 

## Pairs Plot - Liz

```{r pairs_plot, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.asp=0.8}
# Create pairs plot 
pairs_plot <- ggpairs(
  numeric_cols,
  upper = list(continuous = wrap("cor", size = 6, color = "black")), 
  lower = list(continuous = wrap("points", alpha = 0.6, size = 2)), 
  diag  = list(continuous = wrap("densityDiag", alpha = 0.5))        
) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, color = "black"),
    strip.text = element_text(size = 14, color = "black")
  )

# Save as PNG
ggsave("full_pairs_plot_points_bigger.png", plot = pairs_plot, width = 25, height = 25, units = "in", dpi = 300)
```


## Box Plot - Harry
```{r boxplots, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.asp=0.8}


# Select numeric features for scaling 
X <- data[, 3:14]                    #all numerical catergories
X <- as.data.frame(scale(X))         # z-scores per variable
X$.row <- 1:nrow(X)

# reshaping is to long for ggplot so use tidyr library
box_long <- pivot_longer(           #tidyr
  X,
  cols = - .row,
  names_to = "variable",
  values_to = "value"
)

# boxplots on a common axis (z-scored)
ggplot(box_long, aes(x = variable, y = value)) +
  geom_boxplot(notch = TRUE, outlier.alpha = 0.6, na.rm = TRUE) +
  coord_flip() +
  labs(x = NULL, y = "Scaled value (z-score)",
       title = "Serbian spa water: Boxplots of all variables (z-scored)") +
  theme(panel.grid.minor = element_blank())
```
Variables were standardised to z-scores to allow direct comparison despite differing measurement units. The boxplots show that some features (e.g. Na⁺, Cl⁻, HCO₃⁻) have greater variability and distinct outliers, while others remain tightly clustered around the mean. This highlights which chemical measures are most heterogeneous across the spa waters.



## Correlation matrix - Harry

```{r corrplot, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
cor_mat <- cor(X, use = "pairwise.complete.obs", method = "pearson")
corrplot(cor_mat,
         method = "color",        
         type = "upper",          
         order = "hclust",        
         addCoef.col = "black",   
         number.cex = 0.7,        
         tl.col = "black",        
         tl.srt = 45,             
         diag = FALSE, 
         col = colorRampPalette(c("firebrick3","white","steelblue4"))(200)
        
)
```
Electrical conductivity, total solids, sodium, potassium, and chloride form a strongly correlated cluster, indicating they vary together across spa waters. In contrast, pH shows moderate negative correlations with several ions (e.g., Ca²⁺, Mg²⁺, HCO₃⁻), suggesting different geochemical influences. Overall, the matrix highlights both tightly linked chemical groups and variables with weaker or opposing trends.


## Eigenvalues - Claire

## PCA - Leah
```{r echo=FALSE, warning=FALSE, message=FALSE, PC-Elbow-Plot, fig.cap="Figure 4: PCA plot", fig.asp=0.8}
library(plotly)
pca_fit <- prcomp(data[3:14], center=TRUE, scale. = TRUE) # apply pca on relevant explanatory numerical columns 
plot(pca_fit, type="l")
```

* PC1 explains most of the variance (around 4)  
* PC2 explains a fair part of the variance
* At PC3 and 4, the extra variance explained is a bit less  
* From PC5, the line starts to flatten  
* Each additional component after PC5 only adds a tiny bit of variance. 

```{r echo=FALSE, PC-Summary-tab}
summary(pca_fit)
```

* PC1 has a standard deviation of 2.05, and explains 35.1% of the variance
* PC2 adds 17.6%, and explains 52.6% of the variance
* PC3 adds 12.4%, and explains 65.0% of the variance  
* PC4 adds 9.7%, and explains 74.7% of the variance
* After PC4 onwards, each PC explains less than 9% of the extra variance
* PC5 explains 83.2% of the variance
* PC6 explains 90.5% of the variance
* PC9 explains the most variance (99.1%)

```{r}
pca_fit
```

* In PC1, $HCO_3^-(-0.447), Na^+(-0.408), elecCond(-0.394), K^+(-0.399), totSolid(-0.350)$ have the highest influence. PC1 strongly correlates with variables relating to major ions and total dissolved content. PC1 measures the overall mineralisation and ionisation levels of the water. Samples with a more negative score are more mineralised waters, whereas samples with a more positive score are more dilute waters. 
* PC2: $Mg^{2+}(0.507), Ca^{2+}(-0.195), tempCels(-0.473), pH(-0.302)$, have the strongest influence. PC2 separates water with high Calcium and Magnesium(hardness) from waters at higher temperatures and pH(alkalinity). This could mean that there is a difference between hard, cold waters and warmer, alkaline waters.   
* PC3: $SiO_2(-0.473), SO^{2−}_4(-0.292), Cl^−(0.406), totSolid(0.277)$ have the strongest influence. Waters that have more Silica and Sulfate have less chloride and mineralisation.  
* PC4: $SiO_2(0.383), Ca^{2+}(-0.315), Cl^−(0.505), totSolid(0.446)$ have the strongest influence. Waters with more sulfate, chlorine and mineralisation have less calcium. 

[will have to do some research to look into the constrasts between explanatory variables - Leah]

# Multivariate Normal - Harry
```{r multivariate normal, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.asp=0.8}
# Fit MANOVA model using geoStruct as grouping
fit <- manova(as.matrix(X) ~ data$geoStruct)
# Extract residuals
res <- residuals(fit)
# Mahalanobis distances of residuals
mu_res <- colMeans(res)
S_res  <- cov(res)
d2_res <- mahalanobis(res, center = mu_res, cov = S_res)

# Degrees of freedom = number of variables
p <- ncol(res)

# QQ-plot
qqplot(qchisq(ppoints(nrow(res)), df = p), d2_res,
       main = "QQ-plot of MANOVA residuals",
       xlab = expression(paste(chi^2, " quantiles")),
       ylab = expression(paste("Ordered residual ", d[M]^2)))
abline(0,1,col="steelblue4")
```
The QQ-plot of MANOVA residual Mahalanobis distances against the theoretical $\chi^2$ distribution provides a diagnostic for assessing multivariate normality. If the residuals were perfectly normal, the points would lie close to the 45° line. In this case, the points deviate fairly evenly across the range of quantiles, rather than only at one end, indicating that the residuals are not an exact match to the multivariate Gaussian model. The upper tail in particular shows noticeable departures, with the largest residuals exceeding the expected $\chi^2$ quantiles, which indicates potential heavy-tailed behaviour or the presence of outliers. Strictly speaking, this means the assumption of multivariate normality is not fully satisfied. Nevertheless, since most observations adhere reasonably closely to the expected distribution, it is common in practice to proceed under the approximate normality assumption while acknowledging these limitations and interpreting MANOVA results with some caution.


# Surprising Observations - Claire




# Factor Analysis

# geoStruct groups


